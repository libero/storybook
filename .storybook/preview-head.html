<script>
  const findValue = (attribute) => {

    const strWithInitialCapital = (str) => {
      return `${str.charAt(0).toUpperCase()}${str.substring(1)}`;
    };

    const attributeSource = document.querySelector(`[data-storybook-htmlattr-${attribute}]`);
    if (attributeSource) {
      return attributeSource.dataset[`storybookHtmlattr${strWithInitialCapital(attribute)}`];
    }
    return '';
  };

  const updateHtmlAttributes = function(toUpdate, allowed) {
    allowed.forEach(function(allowedAttribute) {
      if (toUpdate === allowedAttribute) {
        const value = findValue(allowedAttribute.name) || allowedAttribute.defaultValue;
        if (value && value.length) {
          document.querySelector('html').setAttribute(allowedAttribute, value);
        }
      }
    });
  };

  const allowedAttributes = [
    {
      name: 'lang',
      defaultValue: 'en',
    },
    {
      name: 'dir',
      defaultValue: 'ltr',
    },
  ];

  // The event listener is flaky. Backed up with a 3s timeout if nothing's fired by then.
  const timeout = window.setTimeout(function () {
    updateHtmlAttributes(['dir', 'lang'], allowedAttributes);
  }, 3000);

  window.self.addEventListener('load', function() {
    window.clearTimeout(timeout);
    updateHtmlAttributes(['dir', 'lang'], allowedAttributes);
  });
</script>
